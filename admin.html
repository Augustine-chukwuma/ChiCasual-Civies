<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChiCasual Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="container">
  <h2 class="animate__animated animate__pulse animate__infinite">ChiCasual Admin Panel</h2>

  <!-- Login Section -->
  <div id="login-section" class="animate__animated animate__fadeIn">
    <input type="text" id="admin-email" placeholder="Enter admin email" required />
    <input type="password" id="admin-password" placeholder="Enter admin password" required />
    <button onclick="loginAdmin()">Login</button>
    <div id="login-error" class="message error hidden">Login failed.</div>
  </div>

  <!-- Admin Content Section -->
  <div id="admin-content" class="hidden animate__animated animate__fadeInUp">
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search products by name or category..." aria-label="Search products">
      <button id="search-button">Search</button>
    </div>

    <form id="upload-form" enctype="multipart/form-data" class="animate__animated animate__zoomIn">
      <input type="text" name="productName" placeholder="Product Name" required />
      <input type="number" name="productPrice" placeholder="Price (₦)" required />
      <select name="productCategory" required>
        <option value="">Select Category</option>
        <option value="shoe">Shoe</option>
        <option value="senators">Senators</option>
        <option value="caps">Caps</option>
        <option value="shirts">Shirts</option>
        <option value="shorts">Shorts</option>
        <option value="trousers">Trousers</option>
      </select>
      <input type="number" name="productDiscount" placeholder="Discount (%)" />
      <input type="file" name="image" accept="image/*" required />
      <button type="submit" id="upload-btn">Upload Product</button>
      <div id="upload-message" class="message hidden"></div>
    </form>

    <div class="product-list">
      <h3>Products</h3>
      <div id="products-container"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_PUBLIC_KEY');

  const loginSection = document.getElementById('login-section');
  const adminContent = document.getElementById('admin-content');
  const productsContainer = document.getElementById('products-container');
  const uploadForm = document.getElementById('upload-form');
  const messageBox = document.getElementById('upload-message');
  const loginError = document.getElementById('login-error');
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const uploadBtn = document.getElementById('upload-btn');

  let session = null;
  let products = [];

  async function loginAdmin() {
    const email = document.getElementById('admin-email').value;
    const password = document.getElementById('admin-password').value;
    if (!email || !password) return;

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      if (!data.user.user_metadata.is_admin) throw new Error('Not an admin');
      session = data.session;
      loginSection.classList.add('hidden');
      adminContent.classList.remove('hidden');
      loadProductsFromServer();
    } catch {
      loginError.classList.remove('hidden');
    }
  }

  function showMessage(msg, type = 'success') {
    messageBox.textContent = msg;
    messageBox.className = `message ${type}`;
    messageBox.classList.remove('hidden');
    setTimeout(() => messageBox.classList.add('hidden'), 3000);
  }

  async function loadProductsFromServer() {
    try {
      const res = await fetch('/api/products');
      const data = await res.json();
      products = data;
      renderProducts(products);
    } catch {
      showMessage('❌ Failed to load products', 'error');
    }
  }

  function renderProducts(list = products) {
    productsContainer.innerHTML = "";
    if (!list.length) {
      productsContainer.innerHTML = '<div class="empty">No products found.</div>';
      return;
    }
    const grid = document.createElement('div');
    grid.className = 'products-grid';
    list.forEach((prod, idx) => {
      const item = document.createElement('div');
      item.className = 'product-item';
      item.style.animationDelay = `${idx * 0.07}s`;
      item.innerHTML = `
        <img src="${prod.image_url}" alt="${prod.name}" />
        <strong>${prod.name}</strong>
        <div class="price">₦${prod.price}</div>
        ${prod.discount ? `<span class="discount">-${prod.discount}%</span>` : ''}
        <div class="category">${prod.category}</div>
      `;
      grid.appendChild(item);
    });
    productsContainer.appendChild(grid);
  }

  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!session) return showMessage('❌ Please login first', 'error');

    const form = e.target;
    const formData = new FormData();
    formData.append('name', form.productName.value.trim());
    formData.append('price', form.productPrice.value);
    formData.append('category', form.productCategory.value.trim());
    formData.append('discount', form.productDiscount.value || 0);
    formData.append('description', '');
    formData.append('image', form.image.files[0]);

    gsap.to(uploadBtn, { scale: 0.95, duration: 0.3, yoyo: true, repeat: -1 });
    try {
      const res = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${session.access_token}` },
        body: formData
      });
      if (!res.ok) throw new Error('Upload failed');
      await loadProductsFromServer();
      form.reset();
      showMessage('✅ Product uploaded!', 'success');
    } catch {
      showMessage('❌ Upload failed', 'error');
    } finally {
      gsap.killTweensOf(uploadBtn);
    }
  });

  searchInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') searchProducts(searchInput.value.trim());
  });
  searchButton.addEventListener('click', () => searchProducts(searchInput.value.trim()));

  function searchProducts(term) {
    term = term.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(term) || p.category.toLowerCase().includes(term));
    renderProducts(filtered);
  }
</script>

</body>
</html>
